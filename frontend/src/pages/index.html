<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Haseeb AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;  /* Prevent global page scrolling */
}

main {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 900px;
    width: 100%;
    margin: 0 auto;
    padding: var(--spacing-lg);
    height: calc(100vh - 80px); /* Fill remaining space minus header/footer */
    box-sizing: border-box;
}

.chat-container {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    position: relative;
}

.messages-container {
    flex: 1;
    padding: var(--spacing-lg);
    overflow-y: auto;  /* Scroll inside this container only */
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
    scroll-behavior: smooth;
}

/* Optional: Hide scrollbar while allowing scroll */
.messages-container::-webkit-scrollbar {
    display: none;
}
.messages-container {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;      /* Firefox */
}

.input-container {
    padding: var(--spacing-md);
    border-top: 1px solid rgba(0, 0, 0, 0.06);
    background: var(--card-bg);
    flex-shrink: 0;   /* Keeps input fixed at bottom */
}

        /* CSS Variables */
        :root {
            --primary-gradient: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%);
            --primary-light: #6C63FF;
            --primary-dark: #5648D9;
            --secondary: #FF6B6B;
            --accent: #4ECDC4;
            --bg-color: #FAFAFF;
            --card-bg: #FFFFFF;
            --user-bubble: #4776E6;
            --ai-bubble: #F0F4FF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --text-light: #A0AEC0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.12);
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        /* Reset & Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* Animated Background Elements */
        .bg-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-element {
            position: absolute;
            border-radius: 50%;
            opacity: 0.08;
            animation: float 20s infinite ease-in-out;
        }

        .bg-element:nth-child(1) {
            width: 200px;
            height: 200px;
            background: var(--primary-light);
            top: 15%;
            left: 5%;
            animation-delay: 0s;
        }

        .bg-element:nth-child(2) {
            width: 120px;
            height: 120px;
            background: var(--secondary);
            top: 65%;
            left: 85%;
            animation-delay: -5s;
        }

        .bg-element:nth-child(3) {
            width: 180px;
            height: 180px;
            background: var(--accent);
            top: 75%;
            left: 10%;
            animation-delay: -10s;
        }

        .bg-element:nth-child(4) {
            width: 90px;
            height: 90px;
            background: var(--primary-dark);
            top: 25%;
            left: 75%;
            animation-delay: -7s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
            33% { transform: translateY(-20px) rotate(5deg) scale(1.05); }
            66% { transform: translateY(10px) rotate(-5deg) scale(0.95); }
        }

        /* Header */
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: var(--spacing-md) var(--spacing-lg);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-weight: 700;
            font-size: 1.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo-icon {
            display: inline-flex;
            background: var(--primary-gradient);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .new-chat-btn {
            background: rgba(71, 118, 230, 0.1);
            border: none;
            cursor: pointer;
            color: var(--primary-light);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }

        .new-chat-btn:hover {
            background: rgba(71, 118, 230, 0.2);
            transform: translateY(-2px);
        }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        .chat-container {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
            position: relative;
        }

        .messages-container {
            flex: 1;
            padding: var(--spacing-lg);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            scroll-behavior: smooth;
        }

        /* Message Bubbles */
        .message {
            display: flex;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
        }

        .message.ai {
            align-self: flex-start;
        }

        .message-bubble {
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            position: relative;
            box-shadow: var(--shadow);
        }

        .user .message-bubble {
            background: var(--primary-gradient);
            color: white;
            border-bottom-right-radius: var(--radius-sm);
        }

        .ai .message-bubble {
            background-color: var(--ai-bubble);
            border-bottom-left-radius: var(--radius-sm);
        }

        .message-content {
            word-wrap: break-word;
        }

        .message-timestamp {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-top: var(--spacing-xs);
            text-align: right;
            opacity: 0.8;
        }

        .ai .message-timestamp {
            text-align: left;
        }

        .user .message-timestamp {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Sources */
        .sources {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .source-pill {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 16px;
            font-size: 0.75rem;
            text-decoration: none;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .ai .source-pill {
            background: rgba(71, 118, 230, 0.15);
            color: var(--primary-light);
        }

        .source-pill:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .ai .source-pill:hover {
            background: rgba(71, 118, 230, 0.25);
        }

        /* Code Blocks */
        pre {
            background: rgba(0, 0, 0, 0.06);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            overflow-x: auto;
            margin: var(--spacing-sm) 0;
            position: relative;
            border-left: 4px solid var(--primary-light);
        }

        .copy-btn {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.7rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        pre:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            transform: scale(1.05);
        }

        /* Input Area */
        .input-container {
            padding: var(--spacing-md);
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            background: var(--card-bg);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .input-inner {
            display: flex;
            gap: var(--spacing-sm);
            align-items: flex-end;
        }

        .textarea-container {
            flex: 1;
            position: relative;
        }

        textarea {
            width: 100%;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            font-family: inherit;
            resize: none;
            min-height: 44px;
            max-height: 200px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background: var(--bg-color);
            font-size: 0.95rem;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(71, 118, 230, 0.2);
        }

        .send-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            height: 44px;
            width: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--ai-bubble);
            border-radius: var(--radius-md);
            align-self: flex-start;
            max-width: 180px;
        }

        .typing-dots {
            display: flex;
            margin-left: var(--spacing-xs);
        }
.message-content ul {
    padding-left: 20px;
    margin: 8px 0;
}

.message-content li {
    margin-bottom: 4px;
    list-style-type: disc;
}

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--primary-light);
            margin: 0 2px;
            opacity: 0.6;
            animation: pulse 1.5s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 0.8; transform: scale(1.2); }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .ai-description {
            max-width: 600px;
            margin-bottom: var(--spacing-lg);
            line-height: 1.6;
        }

        .capabilities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--spacing-md);
            justify-content: center;
            margin: var(--spacing-lg) 0;
            width: 100%;
            max-width: 700px;
        }

        .capability {
            background: linear-gradient(135deg, rgba(71, 118, 230, 0.1) 0%, rgba(142, 84, 233, 0.1) 100%);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(71, 118, 230, 0.1);
        }

        .capability:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .capability-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .prompt-chips {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
            justify-content: center;
        }

        .prompt-chip {
            background: var(--ai-bubble);
            border: none;
            border-radius: 20px;
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .prompt-chip:hover {
            background: var(--primary-gradient);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Error Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff4757;
            color: white;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-hover);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: var(--spacing-md);
            color: var(--text-light);
            font-size: 0.8rem;
            background: var(--card-bg);
            margin-top: auto;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .message {
                max-width: 90%;
            }
            
            header {
                padding: var(--spacing-md);
            }
            
            main {
                padding: var(--spacing-md);
            }
            
            .messages-container {
                padding: var(--spacing-md);
            }
            
            .capabilities {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-sm);
            }
            
            .capability {
                width: 100%;
                padding: var(--spacing-sm);
            }
        }

        @media (max-width: 480px) {
            .message {
                max-width: 95%;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .input-inner {
                flex-direction: column;
                align-items: stretch;
            }
            
            .send-btn {
                width: 100%;
                height: 40px;
                margin-top: var(--spacing-sm);
            }
            
            .capabilities {
                grid-template-columns: 1fr;
            }
            
            .prompt-chips {
                flex-direction: column;
                align-items: center;
            }
            
            .prompt-chip {
                width: 100%;
                max-width: 280px;
            }
        }
    </style>
</head>
<body>
    <!-- Animated background elements -->
    <div class="bg-elements">
        <div class="bg-element"></div>
        <div class="bg-element"></div>
        <div class="bg-element"></div>
        <div class="bg-element"></div>
    </div>

    <header>
        <div class="logo">
            <span class="logo-icon">AI</span>
            Ask Haseeb AI
        </div>
        <button class="new-chat-btn" id="newChatBtn" aria-label="Start new conversation">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            New chat
        </button>
    </header>

    <main>
        <div class="chat-container">
            <div class="messages-container" id="messagesContainer">
                <!-- Empty state with prompt suggestions -->
                <div class="empty-state" id="emptyState">
                    <h2>Welcome to Ask Haseeb AI</h2>
                    
                    <div class="ai-description">
                        <p>I'm your AI assistant designed to help you learn about Haseeb's professional experience, projects, and skills. I can provide detailed information about his work in data science, machine learning, and software development.</p>
                    </div>
                    
                    <div class="capabilities">
                        <div class="capability">
                            <div class="capability-icon">ðŸ“Š</div>
                            <h3>Data Analysis</h3>
                            <p>Explore analytical projects</p>
                        </div>
                        <div class="capability">
                            <div class="capability-icon">ðŸ¤–</div>
                            <h3>ML Models</h3>
                            <p>Learn about AI implementations</p>
                        </div>
                        <div class="capability">
                            <div class="capability-icon">ðŸ’¼</div>
                            <h3>Experience</h3>
                            <p>Professional background</p>
                        </div>
                        <div class="capability">
                            <div class="capability-icon">ðŸš€</div>
                            <h3>Projects</h3>
                            <p>Detailed project breakdowns</p>
                        </div>
                    </div>
                    
                    <p>Try asking me something or choose a prompt below:</p>
                    <div class="prompt-chips">
                        <button class="prompt-chip" data-prompt="Summarize my Telco Churn project">Telco Churn Project</button>
                        <button class="prompt-chip" data-prompt="What ML frameworks are you experienced with?">ML Frameworks</button>
                        <button class="prompt-chip" data-prompt="Tell me about your education background">Education</button>
                        <button class="prompt-chip" data-prompt="What programming languages are you proficient in?">Programming Languages</button>
                    </div>
                </div>
                
                <!-- Messages will be dynamically inserted here -->
            </div>

            <div class="input-container">
                <div class="input-inner">
                    <div class="textarea-container">
                        <textarea 
                            id="messageInput" 
                            placeholder="Ask Haseeb AI..." 
                            rows="1"
                            aria-label="Type your message"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn" aria-label="Send message">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <!-- Typing indicator will appear here when needed -->
            </div>
        </div>
    </main>

    <footer>
        Built by Haseeb Sagheer â€¢ AI Assistant powered by advanced natural language processing
    </footer>

    <!-- Error Toast -->
    <div class="toast" id="errorToast">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 8V12M12 16H12.01M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span id="toastMessage"></span>
    </div>

   <script>
    // DOM Elements
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const emptyState = document.getElementById('emptyState');
    const errorToast = document.getElementById('errorToast');
    const toastMessage = document.getElementById('toastMessage');
    const promptChips = document.querySelectorAll('.prompt-chip');

    // State
    let conversation = [];
    let isWaitingForResponse = false;
    let observer = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', init);

    function init() {
        // Load previous conversation if available
        const savedConversation = localStorage.getItem('askHaseebConversation');
        if (savedConversation) {
            conversation = JSON.parse(savedConversation);
            renderConversation();
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', handleTextareaKeydown);
        messageInput.addEventListener('input', autoResizeTextarea);
        newChatBtn.addEventListener('click', startNewChat);
        document.querySelector('.logo').addEventListener('click', () => location.reload());

        promptChips.forEach(chip => {
            chip.addEventListener('click', () => {
                const prompt = chip.getAttribute('data-prompt');
                messageInput.value = prompt;
                sendMessage();
            });
        });

        // Setup scroll observer for auto-scroll
        observer = new MutationObserver(scrollToBottom);
        observer.observe(messagesContainer, { childList: true, subtree: true });

        // Focus input on load
        messageInput.focus();

        // Add welcome message if it's a new conversation
        if (conversation.length === 0) {
            setTimeout(() => {
                addWelcomeMessage();
            }, 500);
        }
    }

    function addWelcomeMessage() {
        const welcomeMessage = "Hello! I'm Haseeb's AI assistant. I can tell you about my professional experience, projects, and skills in data science and software development. What would you like to know?";
        conversation.push({ role: 'ai', content: welcomeMessage, timestamp: new Date().toISOString() });
        saveConversation();
        renderConversation();
    }

    function autoResizeTextarea() {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + 'px';
    }

    function handleTextareaKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || isWaitingForResponse) return;

        messageInput.value = '';
        messageInput.style.height = 'auto';
        addMessageToUI('user', message);

        conversation.push({ role: 'user', content: message, timestamp: new Date().toISOString() });
        saveConversation();

        if (emptyState.style.display !== 'none') emptyState.style.display = 'none';
        showTypingIndicator();
        setInputState(false);

        try {
            const response = await httpPost('/api/ask', { text: message });
            hideTypingIndicator();

            const sources = (response.sources || []).slice(0, 3).map(source => ({
                title: source.title || 'Source',
                url: source.url || '#'
            }));

            await typewriterEffect(response.answer, sources);

            conversation.push({ role: 'ai', content: response.answer, sources, timestamp: new Date().toISOString() });
            saveConversation();

        } catch (error) {
            hideTypingIndicator();
            showError(error.message || 'Failed to get response. Please try again.');
        } finally {
            setInputState(true);
        }
    }

    async function httpPost(url, data) {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!res.ok) {
            const msg = await res.text().catch(() => '');
            throw new Error(`HTTP ${res.status} ${res.statusText}${msg ? ` â€“ ${msg}` : ''}`);
        }
        return res.json();
    }

    function showTypingIndicator() {
        isWaitingForResponse = true;
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.id = 'typingIndicator';
        typingIndicator.innerHTML = `
            AI is thinking
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;
        messagesContainer.appendChild(typingIndicator);
        scrollToBottom();
    }

    function hideTypingIndicator() {
        isWaitingForResponse = false;
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) typingIndicator.remove();
    }

    // Typewriter Effect with Sources on New Lines
   async function typewriterEffect(text, sources) {
    const messageElement = createMessageElement('ai', '', []);
    messagesContainer.appendChild(messageElement);

    const contentElement = messageElement.querySelector('.message-content');
    let i = 0;
    let speed = 10;
    let typedText = "";

    function typeNextCharacter() {
        if (i < text.length) {
            typedText += text.charAt(i);
            contentElement.innerText = typedText;  // Show as raw text while typing
            i++;
            setTimeout(typeNextCharacter, speed);
        } else {
            // Once typing is done â†’ convert raw text to formatted HTML
            contentElement.innerHTML = formatMessageContent(typedText);

            // Add sources after typing
            if (sources && sources.length > 0) {
                const sourcesElement = document.createElement('div');
                sourcesElement.className = 'sources';
                sourcesElement.style.marginTop = "8px";

                sources.forEach(source => {
                    const sourceLine = document.createElement('div');
                    sourceLine.style.marginBottom = "4px";
                    sourceLine.innerHTML = `<a href="${source.url}" target="_blank" class="source-pill">ðŸ“„ ${source.title}</a>`;
                    sourcesElement.appendChild(sourceLine);
                });

                messageElement.querySelector('.message-bubble').appendChild(sourcesElement);
            }
        }
    }

    return new Promise(resolve => {
        typeNextCharacter();
        setTimeout(resolve, text.length * speed + 500);
    });
}


    function addMessageToUI(role, content) {
        const messageElement = createMessageElement(role, content);
        messagesContainer.appendChild(messageElement);
        scrollToBottom();
    }

    function createMessageElement(role, content, sources = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'message-bubble';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = formatMessageContent(content);

        const timestampDiv = document.createElement('div');
        timestampDiv.className = 'message-timestamp';
        timestampDiv.textContent = formatTime(new Date());

        bubbleDiv.appendChild(contentDiv);
        bubbleDiv.appendChild(timestampDiv);

        if (sources && sources.length > 0) {
            const sourcesDiv = document.createElement('div');
            sourcesDiv.className = 'sources';
            sources.forEach(source => {
                const sourceLink = document.createElement('a');
                sourceLink.href = source.url || '#';
                sourceLink.target = '_blank';
                sourceLink.rel = 'noopener noreferrer';
                sourceLink.className = 'source-pill';
                sourceLink.textContent = `ðŸ“„ ${source.title}`;
                sourcesDiv.appendChild(sourceLink);
            });
            bubbleDiv.appendChild(sourcesDiv);
        }

        messageDiv.appendChild(bubbleDiv);
        return messageDiv;
    }

   function formatMessageContent(content) {
    if (!content) return '';

    // 1) Convert **bold** to <strong>
    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    // 2) Convert lines starting with "- " to <li> items
    // First split into lines
    const lines = content.split('\n').map(line => {
        if (line.trim().startsWith('- ')) {
            return '<li>' + line.trim().substring(2) + '</li>';
        }
        return line;
    });

    // 3) Join lines and wrap <li> items into a <ul>
    let formatted = '';
    let inList = false;
    lines.forEach(line => {
        if (line.startsWith('<li>')) {
            if (!inList) {
                formatted += '<ul>';
                inList = true;
            }
            formatted += line;
        } else {
            if (inList) {
                formatted += '</ul>';
                inList = false;
            }
            formatted += '<p>' + line + '</p>';
        }
    });
    if (inList) formatted += '</ul>'; // Close list if last line was a list item

    return formatted;
}


    function formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function setInputState(enabled) {
        messageInput.disabled = !enabled;
        sendBtn.disabled = !enabled;
        messageInput.placeholder = enabled ? 'Ask Haseeb AI...' : 'Waiting for response...';
    }

    function startNewChat() {
        if (isWaitingForResponse) return;
        if (confirm('Start a new conversation? The current chat will be cleared.')) {
            conversation = [];
            localStorage.removeItem('askHaseebConversation');
            messagesContainer.innerHTML = '';
            emptyState.style.display = 'flex';
            messageInput.focus();
            setTimeout(() => addWelcomeMessage(), 300);
        }
    }

    function renderConversation() {
        messagesContainer.innerHTML = '';
        if (conversation.length === 0) {
            emptyState.style.display = 'flex';
            return;
        }
        emptyState.style.display = 'none';
        conversation.forEach(msg => {
            const messageElement = createMessageElement(msg.role, msg.content, msg.sources);
            if (msg.timestamp) {
                const timestampElement = messageElement.querySelector('.message-timestamp');
                timestampElement.textContent = formatTime(new Date(msg.timestamp));
            }
            messagesContainer.appendChild(messageElement);
        });
        scrollToBottom();
    }

    function saveConversation() {
        localStorage.setItem('askHaseebConversation', JSON.stringify(conversation));
    }

    function showError(message) {
        toastMessage.textContent = message;
        errorToast.classList.add('show');
        setTimeout(() => errorToast.classList.remove('show'), 5000);
    }
</script>

</body>
</html>